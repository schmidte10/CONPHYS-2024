---
title: "Chapter1 - Local Adaptation in a coral reef fish"
author: "Elliott Schmidt"
date: "2023-01-30"
output: html_document
---

```{r setup, include=FALSE, hide=TRUE}
knitr::opts_knit$set(root.dir = "C:/Users/jc527762/OneDrive - James Cook University/PhD dissertation/Data/Local_adaptation/Chapter1_LocalAdaptation/genetic_data/")
```

Load libraries 

```{r libraries, message=FALSE, warnings=FALSE}
library(tidyverse)
library(adegenet) 
library(ade4)
library(dartR)
library(patchwork) 
library(ape)
```

```{r load_data, cache=TRUE}
load("./gl.RData")
```

```{r Allele_frequency_spectrum}
myFreq <-  glMean(gl)
myFreq <- c(myFreq, 1-myFreq)
temp <- density(myFreq, bw=0.05)
hist(myFreq, proba=TRUE, 
     col="cadetblue4", 
     xlab="Allele Frequencies", 
     main="Distribution of Allele Frequencies", 
     nclass=20, 
     ylim = c(0,4)) ;lines(temp$x, temp$y*2, lwd=3)
``` 

```{r Allele_frequency_spectrum2}
# per population 
# need to rename  gl@pop for this to begin work ing 
# currently individuals are listed as pop 
gl@pop
pop.list <- c("SUD", "SUD", "SUD", "SUD", "SUD", 
             "VLA", "VLA", "VLA", "VLA", "VLA", 
             "TON", "TON", "TON", "TON", "TON", 
             "SUD","SUD","SUD","SUD", 
             "VLA",
             "TON", 
             "CHA", "CHA", "CHA", "CHA", "CHA", 
             "KES", "KES", "KES", 
             "CKM", "CKM", "CKM", "CKM", "CKM", 
             "KES", 
             "CKM","CKM","CKM")
gl@pop <- factor(pop.list) 
nPop(gl)
for (i in levels(gl@pop)) {
  myFreq <- glMean(gl[gl@pop == i])
  myFreq <- c(myFreq, 1 - myFreq)
  hist(myFreq, proba=TRUE, 
     col="cadetblue4", 
     xlab="Allele Frequencies", 
     main="Distribution of Allele Frequencies", 
     nclass=20, 
     ylim = c(0,4)) ;lines(temp$x, temp$y*2, lwd=3)
}

``` 

# PCA 

```{r PCA, warning=FALSE} 
load("./pca1.RData")

pca1.df <- as.data.frame(pca1$scores) %>% 
  mutate(ID = gl@ind.names, 
         EXP_ID = factor(gl@pop), 
         POP = factor(substr(EXP_ID, start =2, stop =4)), 
         REEF_NAMES =factor(POP, levels = c("SUD","VLA","TON", "CHA", "KES", "CKM"), 
                      labels = c("Sudbury reef", "Vlassof cay", "Tongue reef", 
                                 "Chauvel reef (southern)", "Kewsick island", "Cockermouth island"))) 
                      

eig <- pca1$eig 

#--- plot ---# 
ggplot(pca1.df, aes(PC1, PC2, color = POP)) + 
  geom_point(size = 0.6, alpha =0.3) + 
  geom_text(aes(label =ID), 
            check_overlap = TRUE, 
            nudge_x = sample(-10:10, 89, replace = TRUE), 
            nudge_y = sample(-10:10, 89, replace = TRUE), show.legend = FALSE) + 
  theme_classic() + 
  coord_equal() + 
  scale_color_manual(values = c("dodgerblue4","cyan4","turquoise1","seagreen2","green4","green2")) +
  guides(color =guide_legend(override.aes = list(alpha =1))) + 
  theme(legend.position =c(0.8,0.8), 
        legend.background = element_rect(color ='black'), 
        legend.title =element_blank()) + 
  xlab(paste0('PC1 (', sprintf('%0.1f%% explained var.', 100*eig[1]/sum(eig)), ")")) + 
  ylab(paste0('PC2 (', sprintf('%0.1f%% explained var.', 100*eig[2]/sum(eig)), ")"))
```

There appears to be a clear separation of fish by region, including Chauvel reef fish being on their own. According the PC! (that explains 40.9% of the varianace), Chauvel reef fish appear to be quite different from the other populations. 

Additional pca's will be made for each population separately to see how individuals are dispersed, and to identify potential outliers 

```{r POP_PCA}
#--- split up populations ---# 
load("C:/Users/jc527762/OneDrive - James Cook University/PhD dissertation/Data/Local_adaptation/Chapter1_LocalAdaptation/genetic_data/pca1cairns1.RData")
load("C:/Users/jc527762/OneDrive - James Cook University/PhD dissertation/Data/Local_adaptation/Chapter1_LocalAdaptation/genetic_data/glcarins.RData")

pca1.df.cairns <- as.data.frame(pca1_cairns$scores) %>% 
  mutate(ID = glcairns@ind.names, 
         EXP_ID = factor(glcairns@pop), 
         POP = factor(substr(EXP_ID, start =2, stop =4)), 
         REEF_NAMES =factor(POP, levels = c("SUD","VLA","TON"), 
                      labels = c("Sudbury reef", "Vlassof cay", "Tongue reef"))) 
                      

eig <- pca1.df.cairns$eig 

#--- plot ---# 
ggplot(pca1.df.cairns, aes(PC1, PC2, color = POP)) + 
  geom_point(size = 0.6, alpha =0.3) + 
  geom_text(aes(label =ID), 
            check_overlap = TRUE, 
            nudge_x = sample(-10:10, 89, replace = TRUE), 
            nudge_y = sample(-10:10, 89, replace = TRUE), show.legend = FALSE) + 
  theme_classic() + 
  coord_equal() + 
  scale_color_manual(values = c("seagreen2","green4","green2")) +
  guides(color =guide_legend(override.aes = list(alpha =1))) + 
  theme(legend.position =c(0.8,0.8), 
        legend.background = element_rect(color ='black'), 
        legend.title =element_blank()) + 
  xlab(paste0('PC1 (', sprintf('%0.1f%% explained var.', 100*eig[1]/sum(eig)), ")")) + 
  ylab(paste0('PC2 (', sprintf('%0.1f%% explained var.', 100*eig[2]/sum(eig)), ")"))

``` 

# DAPC analysis 
Similar to example provided tutorial analysis will be conducted with both 3 and 10 axis kept 
```{r DAPC}
grp4 <- find.clusters(gl, max.n.clust =20, glPca =pca1, n.pca =3, n.clust =4) 
grp12 <- find.clusters(gl, max.n.clust =20, glPca =pca1, n.pca =10, n.clust =12)

#dapc4 <- dapc(gl, grp4$grp, glPca =pca1, n.pca =70, n.da =3) 
a_score <- optim.a.score(dapc5) 

# optimal is X PCs
#dacp4 <- dapc(gl, grp4$grp, glPca = pca1, n.pca = 70, n.da = 3) 
#optim.a.score(dacp4) - best = 5 
#dacp5 <- dapc(gl, grp4$grp, glPca =pca1, n.pca =6, n.da =3)

load("./dapc5.RData")
a_score <- optim.a.score(dapc5)  
scatter(dapc5, scree.pca =TRUE) 

dapctbl <- tibble(pops = gl@pop, inds = gl@ind.names, gDAPC5 = as.factor(dapc5$assign), xDAPC5 =dapc5$ind.coord[,1], yDAPC5 =dapc5$ind.coord[,2], zDAPC =dapc5$ind.coord[, 3])
head(dapctbl) %>% kable() 

# conserved variance
dapc5$var 

# so the variance explained by the individual discriminant aces is 
100*dapc5$var*dapc5$eig/sum(dapc5$eig) 

#--- plot ---# 
ggplot(dapctbl, aes(xDAPC5, yDAPC5, color = gDAPC5)) + 
  geom_point(show.legend =FALSE, 
             alpha =0.5, 
             shape =21, 
             size =0.5) + 
  geom_text(aes(label = inds), 
            show.legend =FALSE, 
            check_overlap =TRUE, 
            nudge_x =5) + 
  theme_bw() + 
  xlab(paste0('DA1 (', sprintf('%0.1f%% explained variance',100*dapc5$var*dapc5$eig[1]/sum(dapc5$eig)),")")) + 
  ylab(paste0('DA2 (', sprintf('%0.1f%% explained variance',100*dapc5$var*dapc5$eig[2]/sum(dapc5$eig)),")"))
```
Compare DAPC without clustering - samples clustered by population
```{r DAPC_non-clustering}
# dapcPop <- dapc(gl, grp = grp4$grp, glPca =pca1, n.pca =70, n.da =2)
# a_score <- optim.a.score(dapcPop) 
# dapcPop <- dapc(gl, grp =grp4$grp, glPca =pca1, n.pca = 6, n.da =2)
# save(dapcPop, file ="./dapcPop.RData")
load("dapcPop.RData")

dapcPoptbl <- tibble(pop =gl@pop, 
                     inds =gl@ind.names, 
                     gdapcPop =factor(dapcPop$assign), 
                     xdapcPop = dapcPop$ind.coord[,1], 
                     ydapcPop =dapcPop$ind.coord[,2]) 
levels(dapcPoptbl$gdapcPop) <- c("Chauvel", "Sudbury Reef/Vlassof Cay", "Cockermouth/Keswick Island", "Tongue Reef")

ggplot(dapcPoptbl, aes(pop, gdapcPop)) + 
  geom_count() + 
  theme_bw() + 
  xlab("site") + 
  ylab("assigned population") + 
  scale_size_continuous(range =c(1,20)) 

g <- ggplot(dapcPoptbl, aes(xdapcPop, ydapcPop)) + 
  geom_point(aes(color =gl@pop, shape = gdapcPop), 
             alpha =0.5) + 
  geom_text(aes(label = gl@ind.names, color = gl@pop), 
            show.legend =FALSE, check_overlap =TRUE, nudge_x =0.2) + 
  theme_bw() + 
  xlab(paste0('DA1 (', sprintf('%0.1f%% explained var.', 100*dapcPop$var*dapcPop$eig[1]/sum(dapcPop$eig)), ")")) +
  ylab(paste0('DA2 (', sprintf('%0.1f%% explained var.', 100*dapcPop$var*dapcPop$eig[2]/sum(dapcPop$eig)), ")")) +
  labs(shape = 'Assigned\npopulation', color = 'Site') + 
  stat_ellipse(aes(xdapcPop, ydapcPop, group =gdapcPop), level =0.99, alpha =0.3, linetype ='dotted') + 
  theme(plot.margin =unit(c(-1,1,1,1), 'cm')); g

g2 <- ggplot(dapcPoptbl, aes(xdapcPop, fill =gl@pop, color = gl@pop)) + 
  geom_density(alpha =0.3) + 
  theme_bw() + 
  xlab("") +
  ylab("") +
  theme(legend.position = 'none', #c(0.1, 0.8),
        axis.text.x = element_blank(),
        axis.ticks.x = element_blank(),
        plot.margin = unit(c(1, 1, -1, 1), 'cm')) 

g2+g  + plot_layout(heights = c(1, 3), ncol = 1)
  

compoplot(dapcPop, col=c("green","blue","red","yellow")) 
```

```{r contribtuion_of_alleles}
contribPopx <- loadingplot(dapcPop$var.contr, threshold = 4.8e-07, axis =1, lab.jitter =1, lab =gl@loc.names, 
                           srt =90, adj=0, 
                           cex.lab =0.5) 

dapcdriverPopx <- contribPopx$var.names
write_lines(dapcdriverPopx, file="./dapcdriver_pops_x.txt") 

freqs <- tab(gl[,gl@loc.names %in% contribPopx$var.names], freq = TRUE)
fr <- as.data.frame(freqs) %>% 
  mutate(grp = dapcPop$assign, pops = gl@pop, inds = gl@ind.names) %>% 
  group_by(grp) %>% 
  summarize(across(contains('ENA'), list(mean))) %>% 
  pivot_longer(cols = -1, names_to = 'Locus', values_to = 'Frequency') 

ggplot(fr, aes(reorder(Locus, Frequency), grp, fill = Frequency)) + 
  geom_tile() + 
  theme_classic() + 
  coord_fixed(ratio = 2/1) + 
  theme(axis.text.x = element_blank()) + 
  xlab("DAPC group") + 
  ylab("Locus")

# by site of origin 
fr.site <- as.data.frame(freqs) %>% 
  mutate(grp = dapcPop$assign, pops = gl@pop, inds = gl@ind.names) %>% 
  group_by(pops) %>% 
  summarize(across(contains('ENA'), list(mean))) %>% 
  pivot_longer(cols = -1, names_to = 'Locus', values_to = 'Frequency') 

ggplot(fr.site, aes(reorder(Locus, Frequency), pops, fill = Frequency)) + 
  geom_tile() + 
  theme_classic() + 
  coord_fixed(ratio = 2/1) + 
  theme(axis.text.x = element_blank()) + 
  xlab("DAPC group") + 
  ylab("Locus")
```

# Neighbour-joining tree 
```{r neighbour-joining tree}
NJ <- load("nj.RData")
par(mfrow=c(1,2))
#plot(NJ, "p", show.tip.label=TRUE,cex=1,font=1) 
plot.phylo(NJ, type = 'fan', tip.color = c("#b05d3f","#7657aa","#b7ab49","#5ca6d3","#6bb376","#ab4e7a")[gl$pop], cex =0.5)
plot.phylo(NJ, type = 'radial',tip.color = c("black","blue","red")[gl$pop], cex =0.5 )
```